<!DOCTYPE html>
<html>

<head>
  <title>Saberchat</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="/stylesheets/main.css">
  <!-- link css for navbar. Don't need to include public/javascript/itemForm.js since item is already logged in and does not need to access login and register forms.  -->
  <link rel="stylesheet" href="/stylesheets/components/header.css">
  <link rel="stylesheet" href="/stylesheets/components/navbar.css">
  <link rel="stylesheet" href="/stylesheets/chat/new.css">

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <script src="/javascript/cafe/cafe-socket.js"></script>

  <!-- I'm using my fontawesome kit -->
  <script src="https://kit.fontawesome.com/dccc745c41.js" crossorigin="anonymous"></script>

</head>

<body onclick="changeOrderConfirmation()">
  <!-- include the navbar via ejs -->
  <%- include('../partials/navbar') %>
  <%- include('../partials/header') %>

  <div class="container mt-5" id="container">
    <div class="row">
      <div class="col-12">
        <div class="jumbotron text-center">
          <h1 style="text-align: center; width: 100%">New Cafe Order</h1>
          <p>Place an order that will be delivered to you at lunch</p>
          <a class="btn btn-primary" href='/cafe'><i class="fas fa-arrow-left"></i> Back</a>
          <a class="btn btn-info" href='/cafe/menu'><i class="fas fa-bars"></i> Menu </a>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8 offset-md-2 col-12">
        <form id="orderForm" action="/cafe/order" method="post">
          <div id="item-selection">

            <div class="search-filter mb-3">
              <i class="fas fa-search"></i>
              <input id="search-input" onkeyup="searchFunction()" class="form-control" type="text" placeholder="Search..." title="Type in product" />
            </div>
          </div>

          <div id="item-list">
            <% types.forEach(type => { %>
              <% if (type.items.length > 0) { %>

                <li class="list-group-item list-group-item-success category-header" id="<%=type._id%>-header" style="margin-top: 40px;">
                  <div class="d-flex w-100 justify-content-between">
                    <h2 class="mb-1"><%=type.name%></h2>
                  </div>
                </li>

                <% type.items.forEach(function(item) { %>
                  <% if (item.isAvailable == true) { %>
                    <div class="list-group-item list-group-item-action form-check menu-item <%=type.name%>" id="item-<%=item.id%>">

                      <!-- Div to put margins on text inside outer div -->
                      <div style="margin-left: 2%;" class="style-div">

                        <input name="check[<%= item._id %>]" id="<%= item._id%>" class="form-check-input" type="checkbox" value="">
                        <select class="num-orders" id="dd_<%=item._id%>" name="<%=item.name%>" onchange="changeOrderConfirmation()">
                          <% if (item.availableItems > 3) { %>
                            <% [1, 2, 3].forEach(function(num) { %>
                              <option><%=num%></option>
                            <% }) %>
                          <% } else { %>
                            <% let val = 0 %>
                            <% [...Array(item.availableItems).keys()].forEach(function(num) { %>
                              <% val = num + 1 %>
                              <option><%=val%></option>
                            <% }) %>
                          <% } %>
                        </select>

                        <% if (!item.price.toString().includes('.')) { %>
                          <label style="margin-left: 1%;" class="form-check-label" for="<%= item._id%>"><strong><%= item.name %></strong> (<%= item.availableItems %> orders available) - $<%= item.price %>.00 <span hidden><%=type.name%></span></label>

                        <% } else if (item.price.toString().split('.')[1].length == 1){ %>
                          <label style="margin-left: 1%;" class="form-check-label" for="<%= item._id%>"><strong><%= item.name %></strong> (<%= item.availableItems %> orders available) - $<%= item.price %>0 <span hidden><%=type.name%></span></label>

                        <% } else { %>
                          <label style="margin-left: 1%;" class="form-check-label" for="<%= item._id%>"><strong><%= item.name %></strong> (<%= item.availableItems %> orders available) - $<%= item.price %><span hidden><%=type.name%></span></label>
                        <% } %>

                        <br />
                        <!-- <span class="form-check-label"><%= item.name %>: $<%= item.price %></span> -->
                      </div>
                    </div>
                  <% }%>
                <% }); %>
                <br class="category-break" id="<%=type._id%>-break"/>
              <% } %>
            <% }) %>
          </div>

          <br />
          <div class="form-group mt-3">
            <textarea id="descInput" class="form-control" name="instructions" placeholder="Add special instructions for your order" maxlength="100" rows="5" onkeyup="changeOrderConfirmation()" onpaste="changeOrderConfirmation()"></textarea>
          </div>

          <br />
          <li class="list-group-item list-group-item-primary">
            <div class="d-flex w-100 justify-content-between">
              <h2 class="mb-1">Order Summary</h2>
            </div>
          </li>

          <div>
            <div style="margin: 0px;" id="order-confirm">
              <span  style="color: blue; margin: 0px;" id="extra-instructions" class="list-group-item list-group-item-action form-check"><strong>Extra Instructions:</strong> None</span>
              <strong style="color: green; margin: 0px;" id="total-cost" class="list-group-item list-group-item-action form-check">Total: $0.00</strong>
            </div>
          </div>

          <br />
          <button type="submit" class="btn btn-lg btn-primary btn-block">Complete your Order</button>
        </form>
        <br />
      </div>
    </div>
  </div>
</body>
<!-- Stylistic file. Changes your order summary based on what you are clicking -->
<script src="/javascript/cafe/newOrder.js"></script>

<script>
  order(orderForm, '<%=currentUser._id%>');


  function searchFunction() {
    const catHeaders = document.getElementsByClassName('category-header') //Category header
    const catBreaks = document.getElementsByClassName('category-break') //Category page break
    const menuItems = document.getElementsByClassName('menu-item')
    const input = document.getElementById("search-input");
    let filter = input.value.toLowerCase();

    for (let item of menuItems) {
      if(!item.textContent.toLowerCase().includes(filter)) {
        $(`#${item.id}`).hide()

      } else {
        $(`#${item.id}`).show()
      }
    }

    let catIncluded; //"Category Included"

    for (let h = 0; h < catHeaders.length; h+= 1) {
      catIncluded = false;

      for (let item of document.getElementsByClassName(catHeaders[h].textContent)) {
        if(item.textContent.toLowerCase().includes(filter)) {
          catIncluded = true;
          break
        }
      }

      if (catIncluded) {
        $(`#${catHeaders[h].id}`).show()
        $(`#${catBreaks[h].id}`).show()

      } else {
        $(`#${catHeaders[h].id}`).hide()
        $(`#${catBreaks[h].id}`).hide()
      }
    }

  }

</script>
</html>

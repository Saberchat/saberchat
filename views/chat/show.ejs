<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport">
  <title>Saberchat</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <!-- link chat stylesheet -->
  <link rel="stylesheet" href="/stylesheets/chat/show.css">
  <link rel="stylesheet" href="/stylesheets/components/navbar.css">

  <!-- using my fontawesome kit -->
  <script src="https://kit.fontawesome.com/dccc745c41.js" crossorigin="anonymous"></script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@popperjs/core@2" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

  <!-- Cdn for formating the dates -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-dateFormat/1.0/jquery.dateFormat.min.js"></script>
</head>
<body>
  <%- include("../partials/navbar") %>
<header class="text-center">
  <div class="container">
    <h1 class="display-4 text-dark"><%= room.name %></h1>
    <p class="text-dark lead mb-3"><%= room.description %></p>
    <% if (room.creator.id.equals(currentUser._id)) { %>
      <a href="/chat/<%= room._id %>/edit" class="btn btn-secondary"><i class="fas fa-cog"></i> Room Settings</a>
    <% } else if(room.type == 'private') { %>
      <!-- leave button/form with bootstrap modal -->
      <form action="/chat/<%= room._id %>/leave" method="post" style="display: inline-block;">
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#leaveModalCenter">
          <i class="fas fa-sign-out-alt"></i> Leave Room
        </button>
        <!-- Modal -->
        <div class="modal fade" id="leaveModalCenter" tabindex="-1" role="dialog" aria-labelledby="leaveModalCenterTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="leaveModalCenterTitle"><i class="fas fa-sign-out-alt"></i> Leave <%= room.name %>?</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                You will need to be invited again to rejoin.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-danger">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    <% } %>
  </div>
</header>
  <div class="container py-5 px-4">
    <div class="row rounded-lg overflow-hidden shadow mt-2">
      <!-- Chat Box-->
      <div class="col-12 px-0">
        <a href="/chat" class="exit-button"><i class="fas fa-long-arrow-alt-left"></i> Exit</a>
        <button class="btn-scrolldown" onclick="scrollBottom()">Scroll To <i class="fas fa-arrow-down"></i></button>
        <div class="px-4 chat-box bg-white" id="message-display">
          <!-- reverse it to get correct order -->
          <% comments.reverse().forEach(comment => { %>
            <% if(comment.status == 'deleted' && comment.author._id.equals(currentUser._id)) { %>
              <!-- Reciever Message-->
              <div class="media w-65 ml-auto mb-2">
                <div class="media-body">
                  <div class="bg-primary rounded py-2 px-3 mb-2">
                    <p class="text-small mb-0 text-white">[Comment deleted by moderator]</p>
                  </div>
                  <p class="small text-muted"><%= comment.date %></p>
                </div>
              </div>
            <% } else if(comment.status == 'deleted') { %>
              <!-- Sender message -->
              <div class="media mb-2">
                <img src="<%= comment.author.imageUrl %>" alt="user" class="user-image">
                <div class="media-body ml-3">
                  <div class="bg-grey rounded py-2 px-3 mb-2 w-65">
                    <p class="text-small mb-0 text-dark">[Comment deleted by moderator]</p>
                  </div>
                  <p class="small text-muted msg-info"><span class="username"><%= comment.author.username %></span>, <%= comment.date %></p>
                  <% if(comment.status != 'reported' && comment.status != 'ignored' && comment.status != 'deleted') { %>
                  <button class="flag" id="<%= comment._id %>" onclick="report(this)"><i class="far fa-flag"></i> <span class="flag-tooltip">Report comment</span></button>
                  <% } %>
                </div>
              </div>
            <% } else if (comment.author && comment.author._id.equals(currentUser._id)) { %>
              <!-- Reciever Message-->
              <div class="media w-65 ml-auto mb-2">
                <div class="media-body">
                  <div class="bg-primary rounded py-2 px-3 mb-2">
                    <p class="text-small mb-0 text-white"><%= comment.text %></p>
                  </div>
                  <p class="small text-muted"><%= comment.date %></p>
                </div>
              </div>
            <% } else if(comment.author) { %>
              <!-- Sender message -->
              <div class="media mb-2">
                <img src="<%= comment.author.imageUrl %>" alt="user" class="user-image">
                <div class="media-body ml-3">
                  <div class="bg-grey rounded py-2 px-3 mb-2 w-65">
                    <p class="text-small mb-0 text-dark"><%= comment.text %></p>
                  </div>
                  <p class="small text-muted msg-info"><span class="username"><%= comment.author.username %></span>, <%= comment.date %></p>
                  <% if(comment.status != 'reported' && comment.status != 'ignored') { %>
                  <button class="flag" id="<%= comment._id %>" onclick="report(this)"><i class="far fa-flag"></i> <span class="flag-tooltip">Report comment</span></button>
                  <% } %>
                </div>
              </div>
            <% } else { %>
              <div class="announcement mb-5">
                <h4><%= comment.text %></h4>
              </div>
            <% } %>
          <% }) %>
      </div>
      <!-- Typing area -->
      <form class="bg-light" id="message-form">
        <div class="input-group">
          <input id="m" type="text" placeholder="Type a message..." aria-describedby="send-button" class="form-control rounded-0 border-0 py-4 bg-light" autocomplete="off">
          <div class="input-group-append">
            <button id="send-button" class="btn btn-link"> <i class="fa fa-paper-plane send-icon"></i></button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- script for socket io chat -->
  <script src="/javascript/chat/socket.js"></script>
  <script>
    //scroll to the last chat message
    let messages = document.getElementsByClassName('media');
    let message = messages[messages.length - 1];
    if(message) {
      scrollToElement(message);
    }

    //set all the variables for the chatInit function
    const userId = '<%= currentUser._id %>';
    const username = '<%= currentUser.username %>';
    const userImage = '<%= currentUser.imageUrl %>';
    const messageForm = '#message-form';
    const input = '#m';
    const chatDisplay = '#message-display';
    const room = '<%= room._id %>';
    // call the chatInit function from public/javascript/socket.js
    chatInit(username, userId, messageForm, input, chatDisplay, room, userImage);
  </script>
  </body>
</html>
